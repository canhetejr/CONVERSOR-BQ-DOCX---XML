<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor BQ – Conversor BQ DOCX → XML</title>
  <style>
    :root {
      --bg: #0f0f0f;
      --surface: #1c1d1c;
      --text: #e8e6e3;
      --muted: #8b8792;
      --accent: #418f3a;
      --accent-hover: #2cc034;
      --btn-text: #fff;
      --success: #52b788;
      --error: #e07a7a;
      --drop-hover-bg: rgba(45, 106, 79, 0.12);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    [data-theme="light"] {
      --bg: #f5f5f0;
      --surface: #fff;
      --text: #1a1a1a;
      --muted: #5c5c5c;
      --accent: #21a700;
      --accent-hover: #30b91e;
      --btn-text: #ebebeb;
      --success: #397a0d;
      --error: #b84545;
      --drop-hover-bg: rgba(30, 126, 52, 0.08);
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 0;
      transition: background 0.25s ease, color 0.25s ease;
    }
    .editor-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
      padding: 1rem 1.5rem;
      background: var(--surface);
      border-bottom: 1px solid var(--muted);
      box-shadow: var(--shadow);
    }
    .editor-header h1 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
    }
    .editor-header a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
    }
    .editor-header a:hover { text-decoration: underline; }
    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .theme-toggle span { font-size: 0.85rem; color: var(--muted); }
    .theme-toggle input { position: absolute; opacity: 0; width: 0; height: 0; }
    .theme-switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
      background: var(--muted);
      border-radius: 24px;
      cursor: pointer;
      transition: background 0.25s ease;
    }
    .theme-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: var(--surface);
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      transition: transform 0.25s ease;
    }
    .theme-toggle input:checked + .theme-switch { background: var(--accent); }
    .theme-toggle input:checked + .theme-switch::after { transform: translateX(20px); }

    .editor-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      padding: 1rem 1.5rem;
      min-height: 0;
    }
    .editor-toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .editor-toolbar .btn-insert {
      padding: 0.5rem 0.9rem;
      font-size: 0.85rem;
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--muted);
      border-radius: 6px;
      cursor: pointer;
    }
    .editor-toolbar .btn-insert:hover { border-color: var(--accent); color: var(--accent); }
    .editor-toolbar .btn-insert.primary {
      background: var(--accent);
      color: var(--btn-text);
      border-color: var(--accent);
    }
    .editor-toolbar .btn-insert.primary:hover { background: var(--accent-hover); }
    .editor-toolbar input[type="file"] { display: none; }
    .editor-toolbar .file-label {
      padding: 0.5rem 0.9rem;
      font-size: 0.85rem;
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--muted);
      border-radius: 6px;
      cursor: pointer;
    }
    .editor-toolbar .file-label:hover { border-color: var(--accent); color: var(--accent); }

    .editor-container {
      flex: 1;
      min-height: 420px;
      border: 1px solid var(--muted);
      border-radius: 8px;
      overflow: hidden;
      background: var(--surface);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    .editor-container .tox-tinymce {
      border: none !important;
      border-radius: 8px;
    }

    .editor-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 1rem;
    }
    .btn {
      padding: 0.75rem 1.25rem;
      font-size: 1rem;
      font-weight: 600;
      color: var(--btn-text);
      background: var(--accent);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s, opacity 0.2s;
    }
    .btn:hover:not(:disabled) { background: var(--accent-hover); }
    .btn.modal-close {
      background: transparent;
      border: 1px solid var(--muted);
      color: var(--text);
    }
    .btn.modal-close:hover { background: var(--muted); opacity: 0.8; }

    .msg {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 8px;
      font-size: 0.9rem;
    }
    .msg.success { background: var(--drop-hover-bg); color: var(--success); }
    .msg.error { background: rgba(224, 122, 122, 0.15); color: var(--error); }
    .msg.hide { display: none; }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--surface);
      color: var(--text);
      border-radius: 12px;
      max-width: 560px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow);
    }
    .modal-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--muted); flex-shrink: 0; }
    .modal-header h2 { margin: 0; font-size: 1.1rem; font-weight: 600; }
    .modal-actions-top {
      display: flex; gap: 0.75rem; padding: 0.5rem 1.25rem; font-size: 0.85rem;
      color: var(--muted); border-bottom: 1px solid var(--muted);
    }
    .modal-actions-top button {
      background: none; border: none; color: var(--accent); cursor: pointer;
      padding: 0; text-decoration: underline;
    }
    .modal-actions-top button:hover { opacity: 0.9; }
    .modal-body { overflow-y: auto; padding: 1rem 1.25rem; }
    .modal-question {
      border: 1px solid var(--muted);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      background: var(--bg);
    }
    .modal-question-header {
      display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem;
    }
    .modal-question-header input[type="checkbox"] {
      margin-top: 0.25rem; accent-color: var(--accent); cursor: pointer;
    }
    .modal-question-num { font-weight: 600; color: var(--accent); font-size: 0.9rem; }
    .modal-question-text {
      font-size: 0.95rem; white-space: pre-wrap; margin: 0 0 0.75rem; line-height: 1.4;
    }
    .modal-options { list-style: none; margin: 0; padding: 0; }
    .modal-options li {
      padding: 0.4rem 0.5rem; margin-bottom: 0.25rem; border-radius: 4px;
      font-size: 0.9rem; border-left: 3px solid transparent;
    }
    .modal-options li.correct {
      border-left-color: var(--success);
      background: var(--drop-hover-bg);
      font-weight: 500;
    }
    .modal-footer {
      padding: 1rem 1.25rem; border-top: 1px solid var(--muted);
      display: flex; gap: 0.75rem; justify-content: flex-end; flex-shrink: 0;
    }
    .modal-footer .btn { width: auto; margin-top: 0; }
  </style>
</head>
<body>
  <header class="editor-header">
    <div>
      <h1>Editor BQ</h1>
      <a href="index.html">← Voltar ao Conversor</a>
    </div>
    <div class="theme-toggle">
      <span id="themeLabel">Escuro</span>
      <label>
        <input type="checkbox" id="themeToggle" aria-label="Alternar tema">
        <span class="theme-switch"></span>
      </label>
    </div>
  </header>

  <div class="editor-wrap">
    <div class="editor-toolbar">
      <button type="button" class="btn-insert" data-insert="#Questão">#Questão</button>
      <button type="button" class="btn-insert" data-insert="#Resposta">#Resposta</button>
      <button type="button" class="btn-insert" data-insert="#Justificativa">#Justificativa</button>
      <button type="button" class="btn-insert" data-insert="#Final">#Final</button>
      <button type="button" class="btn-insert primary" id="btnInsertTemplate">Modelo</button>
      <label class="file-label">
        Carregar .txt
        <input type="file" id="fileLoadTxt" accept=".txt,text/plain">
      </label>
      <button type="button" class="btn-insert" id="btnSaveDraft">Salvar rascunho</button>
      <button type="button" class="btn-insert" id="btnClear">Limpar</button>
    </div>

    <div class="editor-container">
      <textarea id="editorBQ" placeholder="Carregando editor…"></textarea>
    </div>

    <div class="editor-actions">
      <button type="button" class="btn" id="btnConvert">Converter para XML</button>
      <button type="button" class="btn modal-close" id="btnExportTxt">Exportar .txt</button>
    </div>

    <div class="msg hide" id="msg"></div>
  </div>

  <div class="modal-overlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-labelledby="modalTitle">
      <div class="modal-header">
        <h2 id="modalTitle">Revise as questões antes de exportar</h2>
      </div>
      <div class="modal-actions-top">
        <button type="button" id="btnSelectAll">Selecionar todas</button>
        <button type="button" id="btnDeselectAll">Desmarcar todas</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn modal-close" id="btnModalClose">Fechar</button>
        <button type="button" class="btn" id="btnExportXml">Exportar XML</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
  <script src="converter.js"></script>
  <script>
    const THEME_KEY = 'bq-converter-theme';
    const DRAFT_KEY = 'bq-editor-draft';
    const EDITOR_ID = 'editorBQ';
    const root = document.documentElement;
    const themeToggle = document.getElementById('themeToggle');
    const themeLabel = document.getElementById('themeLabel');
    const msg = document.getElementById('msg');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalBody = document.getElementById('modalBody');

    function getPreferredTheme() {
      const saved = localStorage.getItem(THEME_KEY);
      if (saved === 'light' || saved === 'dark') return saved;
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) return 'light';
      return 'dark';
    }
    function applyTheme(theme) {
      if (theme === 'light') root.setAttribute('data-theme', 'light');
      else root.removeAttribute('data-theme');
      themeToggle.checked = theme === 'light';
      themeLabel.textContent = theme === 'light' ? 'Claro' : 'Escuro';
      localStorage.setItem(THEME_KEY, theme);
      updateEditorTheme(theme);
    }
    function updateEditorTheme(theme) {
      const ed = window.tinymce && tinymce.get(EDITOR_ID);
      if (!ed || !ed.getBody()) return;
      const body = ed.getBody();
      if (theme === 'light') {
        body.style.backgroundColor = '#f5f5f0';
        body.style.color = '#1a1a1a';
      } else {
        body.style.backgroundColor = '#1c1d1c';
        body.style.color = '#e8e6e3';
      }
    }

    function showMsg(text, type) {
      msg.textContent = text;
      msg.className = 'msg ' + (type || '');
      msg.classList.remove('hide');
    }
    function hideMsg() { msg.classList.add('hide'); }

    /** Extrai uma linha por bloco (p/div), preservando as tags #Questão etc. por baixo dos panos. */
    function getEditorLines() {
      const ed = tinymce.get(EDITOR_ID);
      if (!ed) return [];
      const body = ed.getBody();
      if (!body || !body.children) return [];
      const lines = [];
      for (let i = 0; i < body.children.length; i++) {
        const el = body.children[i];
        const text = (el.innerText || el.textContent || '').replace(/\s+/g, ' ').trim();
        lines.push(text);
      }
      return lines;
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s == null ? '' : String(s);
      return div.innerHTML;
    }

    /** Define o conteúdo do editor a partir de linhas (cada linha = um parágrafo). Tags preservadas. */
    function setEditorContentFromLines(lines) {
      const ed = tinymce.get(EDITOR_ID);
      if (!ed) return;
      const html = (lines || []).map(function (line) {
        return '<p>' + escapeHtml(line) + '</p>';
      }).join('');
      ed.setContent(html || '<p></p>');
    }

    const BQ_TEMPLATE = [
      'Título ou cabeçalho do banco (opcional)',
      '',
      '#Questão',
      'Enunciado da primeira questão aqui.',
      '',
      '#Resposta',
      'Resposta correta.',
      '',
      '#Resposta',
      'Alternativa errada 1.',
      '#Resposta',
      'Alternativa errada 2.',
      '#Justificativa',
      'Justificativa da resposta.',
      '',
      '#Questão',
      'Enunciado da segunda questão...',
      '',
      '#Resposta',
      'Resposta correta.',
      '#Resposta',
      'Alternativa errada.',
      '#Justificativa',
      'Justificativa.',
      '',
      '#Final'
    ];

    let currentBanco = null;
    let currentBaseFileName = 'banco-editor';

    function openModal() {
      modalOverlay.classList.add('open');
      modalOverlay.setAttribute('aria-hidden', 'false');
    }
    function closeModal() {
      modalOverlay.classList.remove('open');
      modalOverlay.setAttribute('aria-hidden', 'true');
      currentBanco = null;
    }
    function escapeHtmlModal(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }
    function renderModalQuestions(banco) {
      const list = banco.question_list;
      modalBody.innerHTML = '';
      list.forEach(function (q, i) {
        const block = document.createElement('div');
        block.className = 'modal-question';
        block.dataset.index = i;
        const options = [];
        options.push('<li class="correct">' + escapeHtmlModal(q.correct_answer.trim()) + ' <span style="font-size:0.8em;color:var(--success)">(Correta)</span></li>');
        (q.wrong_answer_list || []).forEach(function (a) {
          const t = (a && String(a).trim()) ? escapeHtmlModal(String(a).trim()) : '';
          if (t) options.push('<li>' + t + '</li>');
        });
        block.innerHTML =
          '<div class="modal-question-header">' +
            '<input type="checkbox" class="modal-question-check" id="q' + i + '" checked>' +
            '<label for="q' + i + '" class="modal-question-num">Questão ' + (i + 1) + '</label>' +
          '</div>' +
          '<div class="modal-question-text">' + escapeHtmlModal(q.question.trim()) + '</div>' +
          '<ul class="modal-options">' + options.join('') + '</ul>';
        modalBody.appendChild(block);
      });
    }
    function openReviewModal(banco, baseFileName) {
      currentBanco = banco;
      currentBaseFileName = baseFileName || 'banco-editor';
      renderModalQuestions(banco);
      openModal();
    }
    function setAllChecks(checked) {
      modalBody.querySelectorAll('.modal-question-check').forEach(function (cb) { cb.checked = checked; });
    }
    function getCheckedQuestions() {
      const indexes = [];
      modalBody.querySelectorAll('.modal-question').forEach(function (block) {
        const cb = block.querySelector('.modal-question-check');
        if (cb && cb.checked) indexes.push(parseInt(block.dataset.index, 10));
      });
      return indexes.sort(function (a, b) { return a - b; });
    }

    applyTheme(getPreferredTheme());
    themeToggle.addEventListener('change', function () { applyTheme(themeToggle.checked ? 'light' : 'dark'); });

    var isLight = getPreferredTheme() === 'light';
    tinymce.init({
      selector: '#' + EDITOR_ID,
      promotion: false,
      branding: false,
      height: 420,
      menubar: false,
      plugins: 'lists link paste',
      toolbar: 'undo redo | blocks | bold italic underline strikethrough | bullist numlist | link | removeformat',
      block_formats: 'Parágrafo=p; Título 2=h2; Título 3=h3',
      content_style: 'body { font-family: Segoe UI, system-ui, sans-serif; font-size: 15px; line-height: 1.5; padding: 12px; margin: 0; background: ' + (isLight ? '#f5f5f0' : '#1c1d1c') + '; color: ' + (isLight ? '#1a1a1a' : '#e8e6e3') + '; }',
      paste_as_text: false,
      paste_remove_styles_if_webkit: false,
      valid_elements: 'p,br,strong,em,u,s,a[href],ul,ol,li,h2,h3,h4',
      init_instance_callback: function (ed) {
        updateEditorTheme(getPreferredTheme());

        document.querySelectorAll('.btn-insert[data-insert]').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var tag = btn.getAttribute('data-insert');
            ed.insertContent('<p>' + tag + '</p>');
          });
        });
        document.getElementById('btnInsertTemplate').addEventListener('click', function () {
          setEditorContentFromLines(BQ_TEMPLATE);
          showMsg('Modelo inserido. Edite e formate o texto; as tags # são preservadas.', 'success');
        });

        document.getElementById('fileLoadTxt').addEventListener('change', function (e) {
          var f = e.target.files[0];
          if (!f) return;
          var r = new FileReader();
          r.onload = function () {
            var lines = r.result.split(/\r?\n/);
            setEditorContentFromLines(lines);
            showMsg('Arquivo carregado.', 'success');
          };
          r.readAsText(f, 'UTF-8');
          e.target.value = '';
        });
        document.getElementById('btnSaveDraft').addEventListener('click', function () {
          try {
            localStorage.setItem(DRAFT_KEY, ed.getContent());
            showMsg('Rascunho salvo.', 'success');
          } catch (err) {
            showMsg('Erro ao salvar rascunho.', 'error');
          }
        });
        document.getElementById('btnClear').addEventListener('click', function () {
          ed.setContent('<p></p>');
          hideMsg();
          showMsg('Editor limpo.', 'success');
        });

        document.getElementById('btnExportTxt').addEventListener('click', function () {
          var lines = getEditorLines();
          var text = lines.join('\n');
          if (!text.trim()) { showMsg('Não há conteúdo para exportar.', 'error'); return; }
          var blob = new Blob([text], { type: 'text/plain; charset=utf-8' });
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url;
          a.download = 'banco-bq.txt';
          a.click();
          URL.revokeObjectURL(url);
          showMsg('Arquivo .txt exportado.', 'success');
        });

        document.getElementById('btnConvert').addEventListener('click', function () {
          var lines = getEditorLines();
          hideMsg();
          try {
            var banco = BQConverter.parseTextToBanco(lines.join('\n'));
            if (!banco.question_list.length) {
              showMsg('Nenhuma questão encontrada. Use #Questão, #Resposta, #Justificativa e #Final.', 'error');
              return;
            }
            openReviewModal(banco, 'banco-editor');
          } catch (err) {
            console.error(err);
            showMsg('Erro ao interpretar o texto: ' + (err.message || String(err)), 'error');
          }
        });

        var draft = localStorage.getItem(DRAFT_KEY);
        if (draft) {
          if (draft.trim().indexOf('<') === 0) {
            ed.setContent(draft);
          } else {
            setEditorContentFromLines(draft.split(/\r?\n/));
          }
        }
      }
    });

    document.getElementById('btnSelectAll').addEventListener('click', function () { setAllChecks(true); });
    document.getElementById('btnDeselectAll').addEventListener('click', function () { setAllChecks(false); });
    document.getElementById('btnModalClose').addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', function (e) { if (e.target === modalOverlay) closeModal(); });
    document.getElementById('btnExportXml').addEventListener('click', function () {
      if (!currentBanco) return;
      var indexes = getCheckedQuestions();
      if (indexes.length === 0) {
        showMsg('Selecione ao menos uma questão para exportar.', 'error');
        return;
      }
      var filtered = indexes.map(function (i) { return currentBanco.question_list[i]; });
      var xml = currentBanco.toXmlString(filtered);
      var blob = new Blob([xml], { type: 'application/xml; charset=utf-8' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = currentBaseFileName + '.xml';
      a.click();
      URL.revokeObjectURL(url);
      closeModal();
      showMsg('XML exportado com ' + indexes.length + ' questão(ões).', 'success');
    });
  </script>
</body>
</html>
