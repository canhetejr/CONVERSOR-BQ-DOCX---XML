<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor BQ – Conversor BQ DOCX → XML</title>
  <style>
    :root {
      --bg: #0f0f0f;
      --surface: #1c1d1c;
      --text: #e8e6e3;
      --muted: #8b8792;
      --accent: #418f3a;
      --accent-hover: #2cc034;
      --btn-text: #fff;
      --success: #52b788;
      --error: #e07a7a;
      --drop-hover-bg: rgba(45, 106, 79, 0.12);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    [data-theme="light"] {
      --bg: #f5f5f0;
      --surface: #fff;
      --text: #1a1a1a;
      --muted: #5c5c5c;
      --accent: #21a700;
      --accent-hover: #30b91e;
      --btn-text: #ebebeb;
      --success: #397a0d;
      --error: #b84545;
      --drop-hover-bg: rgba(30, 126, 52, 0.08);
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 0;
      transition: background 0.25s ease, color 0.25s ease;
    }
    .editor-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
      padding: 1rem 1.5rem;
      background: var(--surface);
      border-bottom: 1px solid var(--muted);
      box-shadow: var(--shadow);
    }
    .editor-header h1 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
    }
    .editor-header a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
    }
    .editor-header a:hover { text-decoration: underline; }
    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .theme-toggle span { font-size: 0.85rem; color: var(--muted); }
    .theme-toggle input { position: absolute; opacity: 0; width: 0; height: 0; }
    .theme-switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
      background: var(--muted);
      border-radius: 24px;
      cursor: pointer;
      transition: background 0.25s ease;
    }
    .theme-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: var(--surface);
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      transition: transform 0.25s ease;
    }
    .theme-toggle input:checked + .theme-switch { background: var(--accent); }
    .theme-toggle input:checked + .theme-switch::after { transform: translateX(20px); }

    .editor-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      padding: 1rem 1.5rem;
      min-height: 0;
    }
    .editor-toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .editor-toolbar .btn-insert {
      padding: 0.5rem 0.9rem;
      font-size: 0.85rem;
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--muted);
      border-radius: 6px;
      cursor: pointer;
    }
    .editor-toolbar .btn-insert:hover { border-color: var(--accent); color: var(--accent); }
    .editor-toolbar .btn-insert.primary {
      background: var(--accent);
      color: var(--btn-text);
      border-color: var(--accent);
    }
    .editor-toolbar .btn-insert.primary:hover { background: var(--accent-hover); }
    .editor-toolbar input[type="file"] { display: none; }
    .editor-toolbar .file-label {
      padding: 0.5rem 0.9rem;
      font-size: 0.85rem;
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--muted);
      border-radius: 6px;
      cursor: pointer;
    }
    .editor-toolbar .file-label:hover { border-color: var(--accent); color: var(--accent); }

    .editor-container {
      flex: 1;
      display: flex;
      min-height: 400px;
      border: 1px solid var(--muted);
      border-radius: 8px;
      overflow: hidden;
      background: var(--surface);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    .editor-lines {
      padding: 1rem 0.5rem 1rem 1rem;
      min-width: 2.5rem;
      text-align: right;
      font-family: Consolas, Monaco, monospace;
      font-size: 0.9rem;
      line-height: 1.5;
      color: var(--muted);
      user-select: none;
      overflow: hidden;
    }
    .editor-textarea {
      flex: 1;
      min-width: 0;
      padding: 1rem;
      font-family: Consolas, Monaco, monospace;
      font-size: 0.95rem;
      line-height: 1.5;
      background: var(--bg);
      color: var(--text);
      border: none;
      resize: none;
      outline: none;
    }
    .editor-textarea::placeholder { color: var(--muted); }

    .editor-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 1rem;
    }
    .btn {
      padding: 0.75rem 1.25rem;
      font-size: 1rem;
      font-weight: 600;
      color: var(--btn-text);
      background: var(--accent);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s, opacity 0.2s;
    }
    .btn:hover:not(:disabled) { background: var(--accent-hover); }
    .btn.modal-close {
      background: transparent;
      border: 1px solid var(--muted);
      color: var(--text);
    }
    .btn.modal-close:hover { background: var(--muted); opacity: 0.8; }

    .msg {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 8px;
      font-size: 0.9rem;
    }
    .msg.success { background: var(--drop-hover-bg); color: var(--success); }
    .msg.error { background: rgba(224, 122, 122, 0.15); color: var(--error); }
    .msg.hide { display: none; }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--surface);
      color: var(--text);
      border-radius: 12px;
      max-width: 560px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow);
    }
    .modal-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--muted); flex-shrink: 0; }
    .modal-header h2 { margin: 0; font-size: 1.1rem; font-weight: 600; }
    .modal-actions-top {
      display: flex; gap: 0.75rem; padding: 0.5rem 1.25rem; font-size: 0.85rem;
      color: var(--muted); border-bottom: 1px solid var(--muted);
    }
    .modal-actions-top button {
      background: none; border: none; color: var(--accent); cursor: pointer;
      padding: 0; text-decoration: underline;
    }
    .modal-actions-top button:hover { opacity: 0.9; }
    .modal-body { overflow-y: auto; padding: 1rem 1.25rem; }
    .modal-question {
      border: 1px solid var(--muted);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      background: var(--bg);
    }
    .modal-question-header {
      display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem;
    }
    .modal-question-header input[type="checkbox"] {
      margin-top: 0.25rem; accent-color: var(--accent); cursor: pointer;
    }
    .modal-question-num { font-weight: 600; color: var(--accent); font-size: 0.9rem; }
    .modal-question-text {
      font-size: 0.95rem; white-space: pre-wrap; margin: 0 0 0.75rem; line-height: 1.4;
    }
    .modal-options { list-style: none; margin: 0; padding: 0; }
    .modal-options li {
      padding: 0.4rem 0.5rem; margin-bottom: 0.25rem; border-radius: 4px;
      font-size: 0.9rem; border-left: 3px solid transparent;
    }
    .modal-options li.correct {
      border-left-color: var(--success);
      background: var(--drop-hover-bg);
      font-weight: 500;
    }
    .modal-question-justification {
      margin-top: 0.75rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--muted);
      font-size: 0.9rem;
      color: var(--muted);
    }
    .modal-question-header-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-left: auto;
    }
    .modal-question-header-actions .btn-edit {
      padding: 0.35rem 0.6rem;
      font-size: 0.8rem;
      background: transparent;
      border: 1px solid var(--accent);
      color: var(--accent);
      border-radius: 6px;
      cursor: pointer;
    }
    .modal-question-header-actions .btn-edit:hover { background: var(--drop-hover-bg); }
    .modal-question-edit {
      padding-top: 0.5rem;
    }
    .modal-question-edit label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--muted);
      margin: 0.75rem 0 0.25rem;
    }
    .modal-question-edit label:first-of-type { margin-top: 0; }
    .modal-question-edit textarea {
      width: 100%;
      min-height: 60px;
      padding: 0.5rem;
      font-size: 0.9rem;
      font-family: inherit;
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--muted);
      border-radius: 6px;
      resize: vertical;
    }
    .modal-question-edit textarea:focus { outline: none; border-color: var(--accent); }
    .modal-question-edit .wrong-item {
      display: flex;
      gap: 0.25rem;
      margin-bottom: 0.25rem;
    }
    .modal-question-edit .wrong-item textarea { flex: 1; min-height: 40px; }
    .modal-question-edit .btn-small {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      background: var(--surface);
      border: 1px solid var(--muted);
      color: var(--text);
      border-radius: 4px;
      cursor: pointer;
      flex-shrink: 0;
    }
    .modal-question-edit .btn-small:hover { border-color: var(--accent); color: var(--accent); }
    .modal-question-edit .edit-actions {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
    }
    .modal-footer {
      padding: 1rem 1.25rem; border-top: 1px solid var(--muted);
      display: flex; gap: 0.75rem; justify-content: flex-end; flex-shrink: 0;
    }
    .modal-footer .btn { width: auto; margin-top: 0; }
  </style>
</head>
<body>
  <header class="editor-header">
    <div>
      <h1>Editor BQ</h1>
      <a href="index.html">← Voltar ao Conversor</a>
    </div>
    <div class="theme-toggle">
      <span id="themeLabel">Escuro</span>
      <label>
        <input type="checkbox" id="themeToggle" aria-label="Alternar tema">
        <span class="theme-switch"></span>
      </label>
    </div>
  </header>

  <div class="editor-wrap">
    <div class="editor-toolbar">
      <button type="button" class="btn-insert" data-insert="#Questão">#Questão</button>
      <button type="button" class="btn-insert" data-insert="#Resposta">#Resposta</button>
      <button type="button" class="btn-insert" data-insert="#Justificativa">#Justificativa</button>
      <button type="button" class="btn-insert" data-insert="#Final">#Final</button>
      <button type="button" class="btn-insert primary" id="btnInsertTemplate">Modelo</button>
      <label class="file-label">
        Carregar .txt
        <input type="file" id="fileLoadTxt" accept=".txt,text/plain">
      </label>
      <button type="button" class="btn-insert" id="btnSaveDraft">Salvar rascunho</button>
      <button type="button" class="btn-insert" id="btnClear">Limpar</button>
    </div>

    <div class="editor-container">
      <div class="editor-lines" id="editorLines">1</div>
      <textarea class="editor-textarea" id="editorTextarea" placeholder="Cole ou digite o conteúdo BQ. Cada linha = um parágrafo. Use #Questão, #Resposta, #Justificativa e #Final." spellcheck="false"></textarea>
    </div>

    <div class="editor-actions">
      <button type="button" class="btn" id="btnConvert">Converter para XML</button>
      <button type="button" class="btn modal-close" id="btnExportTxt">Exportar .txt</button>
    </div>

    <div class="msg hide" id="msg"></div>
  </div>

  <div class="modal-overlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-labelledby="modalTitle">
      <div class="modal-header">
        <h2 id="modalTitle">Revise as questões antes de exportar</h2>
      </div>
      <div class="modal-actions-top">
        <button type="button" id="btnSelectAll">Selecionar todas</button>
        <button type="button" id="btnDeselectAll">Desmarcar todas</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn modal-close" id="btnModalClose">Fechar</button>
        <button type="button" class="btn" id="btnExportXml">Exportar XML</button>
      </div>
    </div>
  </div>

  <script src="converter.js"></script>
  <script>
    const THEME_KEY = 'bq-converter-theme';
    const DRAFT_KEY = 'bq-editor-draft';
    const root = document.documentElement;
    const themeToggle = document.getElementById('themeToggle');
    const themeLabel = document.getElementById('themeLabel');
    const editorTextarea = document.getElementById('editorTextarea');
    const editorLines = document.getElementById('editorLines');
    const msg = document.getElementById('msg');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalBody = document.getElementById('modalBody');

    function getPreferredTheme() {
      const saved = localStorage.getItem(THEME_KEY);
      if (saved === 'light' || saved === 'dark') return saved;
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) return 'light';
      return 'dark';
    }
    function applyTheme(theme) {
      if (theme === 'light') root.setAttribute('data-theme', 'light');
      else root.removeAttribute('data-theme');
      themeToggle.checked = theme === 'light';
      themeLabel.textContent = theme === 'light' ? 'Claro' : 'Escuro';
      localStorage.setItem(THEME_KEY, theme);
    }

    function showMsg(text, type) {
      msg.textContent = text;
      msg.className = 'msg ' + (type || '');
      msg.classList.remove('hide');
    }
    function hideMsg() { msg.classList.add('hide'); }

    function updateLineNumbers() {
      const text = editorTextarea.value;
      const n = text ? text.split(/\r?\n/).length : 1;
      editorLines.textContent = Array.from({ length: n }, function (_, i) { return i + 1; }).join('\n');
    }
    editorTextarea.addEventListener('input', updateLineNumbers);
    editorTextarea.addEventListener('scroll', function () { editorLines.scrollTop = editorTextarea.scrollTop; });
    editorTextarea.addEventListener('keydown', function (e) {
      if (e.key === 'Tab') {
        e.preventDefault();
        const start = editorTextarea.selectionStart;
        const end = editorTextarea.selectionEnd;
        editorTextarea.value = editorTextarea.value.slice(0, start) + '\t' + editorTextarea.value.slice(end);
        editorTextarea.selectionStart = editorTextarea.selectionEnd = start + 1;
        updateLineNumbers();
      }
    });

    const BQ_TEMPLATE = [
      'Título ou cabeçalho do banco (opcional)',
      '',
      '#Questão',
      'Enunciado da primeira questão aqui.',
      '',
      '#Resposta',
      'Resposta correta.',
      '',
      '#Resposta',
      'Alternativa errada 1.',
      '#Resposta',
      'Alternativa errada 2.',
      '#Justificativa',
      'Justificativa da resposta.',
      '',
      '#Questão',
      'Enunciado da segunda questão...',
      '',
      '#Resposta',
      'Resposta correta.',
      '#Resposta',
      'Alternativa errada.',
      '#Justificativa',
      'Justificativa.',
      '',
      '#Final'
    ].join('\n');

    document.querySelectorAll('.btn-insert[data-insert]').forEach(function (btn) {
      btn.addEventListener('click', function () {
        var tag = btn.getAttribute('data-insert');
        var start = editorTextarea.selectionStart;
        var end = editorTextarea.selectionEnd;
        var inserted;
        if (start === end) {
          inserted = tag + '\n';
          editorTextarea.value = editorTextarea.value.slice(0, start) + inserted + editorTextarea.value.slice(end);
          editorTextarea.selectionStart = editorTextarea.selectionEnd = start + inserted.length;
        } else {
          inserted = '\n' + tag + '\n';
          editorTextarea.value = editorTextarea.value.slice(0, start) + inserted + editorTextarea.value.slice(start, end) + editorTextarea.value.slice(end);
          editorTextarea.selectionStart = start + inserted.length;
          editorTextarea.selectionEnd = end + inserted.length;
        }
        editorTextarea.focus();
        updateLineNumbers();
      });
    });
    document.getElementById('btnInsertTemplate').addEventListener('click', function () {
      editorTextarea.value = BQ_TEMPLATE;
      updateLineNumbers();
      showMsg('Modelo inserido. Edite conforme necessário.', 'success');
    });

    document.getElementById('fileLoadTxt').addEventListener('change', function (e) {
      var f = e.target.files[0];
      if (!f) return;
      var r = new FileReader();
      r.onload = function () {
        editorTextarea.value = r.result;
        updateLineNumbers();
        showMsg('Arquivo carregado.', 'success');
      };
      r.readAsText(f, 'UTF-8');
      e.target.value = '';
    });
    document.getElementById('btnSaveDraft').addEventListener('click', function () {
      try {
        localStorage.setItem(DRAFT_KEY, editorTextarea.value);
        showMsg('Rascunho salvo.', 'success');
      } catch (err) {
        showMsg('Erro ao salvar rascunho.', 'error');
      }
    });
    document.getElementById('btnClear').addEventListener('click', function () {
      editorTextarea.value = '';
      updateLineNumbers();
      hideMsg();
      showMsg('Editor limpo.', 'success');
    });

    document.getElementById('btnExportTxt').addEventListener('click', function () {
      var text = editorTextarea.value;
      if (!text.trim()) { showMsg('Não há conteúdo para exportar.', 'error'); return; }
      var blob = new Blob([text], { type: 'text/plain; charset=utf-8' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'banco-bq.txt';
      a.click();
      setTimeout(function () { URL.revokeObjectURL(url); }, 200);
      showMsg('Arquivo .txt exportado.', 'success');
    });

    var currentBanco = null;
    var currentBaseFileName = 'banco-editor';

    function openModal() {
      modalOverlay.classList.add('open');
      modalOverlay.setAttribute('aria-hidden', 'false');
    }
    function closeModal() {
      modalOverlay.classList.remove('open');
      modalOverlay.setAttribute('aria-hidden', 'true');
      currentBanco = null;
    }
    function escapeHtml(s) {
      var div = document.createElement('div');
      div.textContent = s == null ? '' : String(s);
      return div.innerHTML;
    }
    function renderModalQuestions(banco) {
      var list = banco.question_list || [];
      modalBody.innerHTML = '';
      list.forEach(function (q, i) {
        var block = document.createElement('div');
        block.className = 'modal-question';
        block.dataset.index = String(i);
        var questionText = (q.question != null ? String(q.question) : '').trim();
        var correctText = (q.correct_answer != null ? String(q.correct_answer) : '').trim();
        var options = [];
        options.push('<li class="correct">' + escapeHtml(correctText) + ' <span style="font-size:0.8em;color:var(--success)">(Correta)</span></li>');
        (q.wrong_answer_list || []).forEach(function (a) {
          var t = (a != null && String(a).trim()) ? escapeHtml(String(a).trim()) : '';
          if (t) options.push('<li>' + t + '</li>');
        });
        var justificationText = (q.justification != null ? String(q.justification) : '').trim();
        var justificationHtml = justificationText ? '<div class="modal-question-justification"><strong>Justificativa:</strong> ' + escapeHtml(justificationText) + '</div>' : '';
        block.innerHTML =
          '<div class="modal-question-header">' +
            '<input type="checkbox" class="modal-question-check" id="q' + i + '" checked>' +
            '<label for="q' + i + '" class="modal-question-num">Questão ' + (i + 1) + '</label>' +
            '<div class="modal-question-header-actions"><button type="button" class="btn-edit" data-edit-index="' + i + '">Editar</button></div>' +
          '</div>' +
          '<div class="modal-question-content">' +
            '<div class="modal-question-text">' + escapeHtml(questionText) + '</div>' +
            '<ul class="modal-options">' + options.join('') + '</ul>' +
            justificationHtml +
          '</div>';
        modalBody.appendChild(block);
      });
      modalBody.querySelectorAll('.btn-edit').forEach(function (btn) {
        btn.addEventListener('click', function () {
          var idx = parseInt(btn.getAttribute('data-edit-index'), 10);
          if (Number.isNaN(idx) || !currentBanco || !currentBanco.question_list[idx]) return;
          openEditForm(modalBody.querySelector('.modal-question[data-index="' + idx + '"]'), idx);
        });
      });
    }

    function openEditForm(block, index) {
      var q = currentBanco.question_list[index];
      var wrongList = q.wrong_answer_list || [];
      var wrongsHtml = wrongList.map(function (a, j) {
        return '<div class="wrong-item">' +
          '<textarea class="edit-wrong" data-wrong-index="' + j + '" rows="2">' + escapeHtml(String(a || '').trim()) + '</textarea>' +
          '<button type="button" class="btn-small btn-remove-wrong" title="Remover">−</button>' +
        '</div>';
      }).join('');
      var editHtml =
        '<div class="modal-question-edit">' +
          '<label>Enunciado</label>' +
          '<textarea class="edit-question" rows="4">' + escapeHtml((q.question != null ? String(q.question) : '').trim()) + '</textarea>' +
          '<label>Resposta correta</label>' +
          '<textarea class="edit-correct" rows="2">' + escapeHtml((q.correct_answer != null ? String(q.correct_answer) : '').trim()) + '</textarea>' +
          '<label>Alternativas erradas</label>' +
          '<div class="wrong-list">' + wrongsHtml + '</div>' +
          '<button type="button" class="btn-small" id="btnAddWrong">+ Adicionar alternativa</button>' +
          '<label>Justificativa</label>' +
          '<textarea class="edit-justification" rows="3">' + escapeHtml((q.justification != null ? String(q.justification) : '').trim()) + '</textarea>' +
          '<div class="edit-actions">' +
            '<button type="button" class="btn modal-close btn-cancel-edit">Cancelar</button>' +
            '<button type="button" class="btn btn-save-edit">Salvar</button>' +
          '</div>' +
        '</div>';
      var content = block.querySelector('.modal-question-content');
      if (content) {
        content.innerHTML = editHtml;
        var wrongListEl = content.querySelector('.wrong-list');
        content.querySelector('#btnAddWrong').addEventListener('click', function () {
          var div = document.createElement('div');
          div.className = 'wrong-item';
          div.innerHTML = '<textarea class="edit-wrong" rows="2" placeholder="Nova alternativa"></textarea><button type="button" class="btn-small btn-remove-wrong" title="Remover">−</button>';
          wrongListEl.appendChild(div);
          div.querySelector('.btn-remove-wrong').addEventListener('click', function () { div.remove(); });
        });
        content.querySelectorAll('.btn-remove-wrong').forEach(function (btn) {
          btn.addEventListener('click', function () { btn.closest('.wrong-item').remove(); });
        });
        content.querySelector('.btn-cancel-edit').addEventListener('click', function () {
          renderModalQuestions(currentBanco);
        });
        content.querySelector('.btn-save-edit').addEventListener('click', function () {
          var question = content.querySelector('.edit-question').value.trim();
          var correct = content.querySelector('.edit-correct').value.trim();
          var wrongs = Array.from(content.querySelectorAll('.edit-wrong')).map(function (ta) { return ta.value.trim(); }).filter(Boolean);
          var justification = content.querySelector('.edit-justification').value.trim();
          q.question = question;
          q.correct_answer = correct;
          q.wrong_answer_list = wrongs;
          q.justification = justification;
          renderModalQuestions(currentBanco);
        });
      }
    }
    function setAllChecks(checked) {
      modalBody.querySelectorAll('.modal-question-check').forEach(function (cb) { cb.checked = checked; });
    }
    function getCheckedQuestions() {
      var indexes = [];
      modalBody.querySelectorAll('.modal-question').forEach(function (block) {
        var cb = block.querySelector('.modal-question-check');
        var idx = parseInt(block.dataset.index, 10);
        if (cb && cb.checked && !Number.isNaN(idx)) indexes.push(idx);
      });
      return indexes.sort(function (a, b) { return a - b; });
    }

    applyTheme(getPreferredTheme());
    themeToggle.addEventListener('change', function () { applyTheme(themeToggle.checked ? 'light' : 'dark'); });

    document.getElementById('btnConvert').addEventListener('click', function () {
      var text = editorTextarea.value;
      hideMsg();
      try {
        var banco = BQConverter.parseTextToBanco(text);
        if (!banco.question_list || !banco.question_list.length) {
          showMsg('Nenhuma questão encontrada. Use #Questão, #Resposta, #Justificativa e #Final.', 'error');
          return;
        }
        currentBanco = banco;
        currentBaseFileName = 'banco-editor';
        renderModalQuestions(banco);
        openModal();
      } catch (err) {
        console.error(err);
        showMsg('Erro ao interpretar o texto: ' + (err.message || String(err)), 'error');
      }
    });

    document.getElementById('btnSelectAll').addEventListener('click', function () { setAllChecks(true); });
    document.getElementById('btnDeselectAll').addEventListener('click', function () { setAllChecks(false); });
    document.getElementById('btnModalClose').addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', function (e) { if (e.target === modalOverlay) closeModal(); });
    document.getElementById('btnExportXml').addEventListener('click', function () {
      if (!currentBanco || !currentBanco.question_list) return;
      var indexes = getCheckedQuestions();
      if (indexes.length === 0) {
        showMsg('Selecione ao menos uma questão para exportar.', 'error');
        return;
      }
      var filtered = indexes.map(function (i) { return currentBanco.question_list[i]; }).filter(Boolean);
      var xml = currentBanco.toXmlString(filtered);
      var blob = new Blob([xml], { type: 'application/xml; charset=utf-8' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = (currentBaseFileName || 'banco-editor') + '.xml';
      a.click();
      setTimeout(function () { URL.revokeObjectURL(url); }, 200);
      closeModal();
      showMsg('XML exportado com ' + indexes.length + ' questão(ões).', 'success');
    });

    var draft = localStorage.getItem(DRAFT_KEY);
    if (draft != null && draft !== '') {
      editorTextarea.value = draft;
      updateLineNumbers();
    }
    updateLineNumbers();
  </script>
</body>
</html>
